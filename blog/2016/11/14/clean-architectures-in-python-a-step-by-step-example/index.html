<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
        <title>Clean architectures in Python: a step-by-step example - The Digital Cat</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="description" content="How to create software that can be easily changed and adapted, following the clean architecture principles">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="Clean architectures in Python: a step-by-step example" />
<meta name="twitter:description" content="How to create software that can be easily changed and adapted, following the clean architecture principles" />
<meta name="twitter:image" content="https://www.thedigitalcatonline.com/images/clean-architectures.jpg" />
		<script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,400italic,600italic|Roboto+Slab:400,700">

        <link rel="stylesheet" href="/theme/css/main.min.css?59943907">

        
        <link href="/images/global/favicon.jpg" rel="icon">

        <!-- Google Analytics Universal -->
        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-74364524-1', 'auto');
            ga('send', 'pageview');
        </script>
        <!-- End Google Analytics Universal Code -->

<script type="application/ld+json">
  {
      "@context" : "https://schema.org",
      "@type" : "Article",
      "name" : "Clean architectures in Python: a step-by-step example",
      "author" : {
	  "@type" : "Person",
	  "name" : "Leonardo Giordani"
      },
      "publisher" : {
	  "@type" : "Organization",
	  "name" : "The Digital Cat",
	  "logo" : {
	      "@type" : "ImageObject",
	      "url" : "https://www.thedigitalcatonline.com/images/global/logo_200.jpg",
	      "height" : 200,
	      "width" : 200
	  }
      },
      "mainEntityOfPage": {
	  "@type": "WebPage",
	  "@id": "https://www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/"
      },
      "datePublished" : "14/11/2016",
      "dateModified" : "29/12/2018",
      "image" : "https://www.thedigitalcatonline.com/images/clean-architectures.jpg",
      "description" : "How to create software that can be easily changed and adapted, following the clean architecture principles",
      "headline" : "How to create software that can be easily changed and adapted, following the clean architecture principles",
      "url" : "https://www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/"
  }
</script>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

<header id="header">
  <a class="logo" href="/category/programming/" title="Programming">All posts in category Programming <i class="fas fa-link"></i></a>
  <div class="align-right">
  </div>
</header>

<!-- <article class="post"> -->

  <section id="header">
    <header class="main">
      <h1>Clean architectures in Python: a step-by-step example</h1>
    </header>
  </section>

  <section id="post-info">
    <p class="article-info">
    By Leonardo Giordani

    <span class="fas fa-calendar-alt"></span> <time datetime="2016-11-14T19:00:00+00:00"> 14/11/2016</time>

    <span class="fas fa-edit"></span> <time datetime="2018-12-29T08:50:00+00:00"> 29/12/2018</time>

    <span class="fas fa-tags"></span>
    <a class="tag" href="/categories/oop/">OOP</a>    <a class="tag" href="/categories/python/">Python</a>    <a class="tag" href="/categories/python2/">Python2</a>    <a class="tag" href="/categories/python3/">Python3</a>    <a class="tag" href="/categories/tdd/">TDD</a>    <a class="tag" href="/categories/architectures/">architectures</a>    <br>
    Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=Clean%20architectures%20in%20Python%3A%20a%20step-by-step%20example&url=https%3A//www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/&via=thedigicat&hashtags=oop,python,python2,python3,tdd,architectures" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/&title=Clean%20architectures%20in%20Python%3A%20a%20step-by-step%20example&summary=How%20to%20create%20software%20that%20can%20be%20easily%20changed%20and%20adapted%2C%20following%20the%20clean%20architecture%20principles&source=https%3A//www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=Clean%20architectures%20in%20Python%3A%20a%20step-by-step%20example&u=https%3A//www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=Clean%20architectures%20in%20Python%3A%20a%20step-by-step%20example&amp;body=https%3A//www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/&title=Clean%20architectures%20in%20Python%3A%20a%20step-by-step%20example" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span>    </p>
  </section>

  <section id="content">
    <p><strong>Update</strong>: <em>an expanded version of this post may be found in "Clean Architectures in Python", a book I published on LeanPub. The book features 3 chapters on TDD with pytest, mocks and unit testing in general, and 4 chapters on clean architectures. Those chapters are very similar to this post, but they include a discussion and examples of integration between the architecture and real-world databases. The book is free and can be downloaded <a href="https://leanpub.com/clean-architectures-in-python">here</a>.</em></p>
<p>In 2015 I was introduced by my friend <a href="https://github.com/gekorob">Roberto Ciatti</a> to the concept of Clean Architecture, as it is called by Robert Martin. The well-known Uncle Bob talks a lot about this concept at conferences and wrote some very interesting posts about it. What he calls "Clean Architecture" is a way of structuring a software system, a set of consideration (more than strict rules) about the different layers and the role of the actors in it.</p>
<p>As he clearly states in a post aptly titled <a href="https://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html">The Clean Architecture</a>, the idea behind this design is not new, being built on a set of concepts that have been pushed by many software engineers over the last 3 decades. One of the first implementations may be found in the Boundary-Control-Entity model proposed by Ivar Jacobson in his masterpiece "Object-Oriented Software Engineering: A Use Case Driven Approach" published in 1992, but Martin lists other more recent versions of this architecture.</p>
<p>I will not repeat here what he had already explained better than I can do, so I will just point out some resources you may check to start exploring these concepts:</p>
<ul>
<li><a href="https://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html">The Clean Architecture</a> a post by Robert Martin that concisely describes the goals of the architecture. It also lists resources that describe similar architectures.</li>
<li><a href="https://blog.8thlight.com/uncle-bob/2014/05/12/TheOpenClosedPrinciple.html">The Open Closed Principle</a> a post by Robert Martin not strictly correlated with the Clean Architecture concept but important for the separation concept.</li>
<li>Hakka Labs: Robert "Uncle Bob" Martin - <a href="https://www.youtube.com/watch?v=HhNIttd87xs">Architecture: The Lost Years</a> a video of Robert Martin from Hakka Labs.</li>
<li><a href="http://www.taimila.com/blog/ddd-and-testing-strategy/">DDD &amp; Testing Strategy</a> by Lauri Taimila</li>
<li>(upcoming) <a href="https://www.amazon.co.uk/Clean-Architecture-Robert-C-Martin-x/dp/0134494164/ref=la_B000APG87E_1_3?s=books&amp;ie=UTF8&amp;qid=1479146201&amp;sr=1-3">Clean Architecture</a> by Robert Martin, published by Prentice Hall.</li>
</ul>
<p>The purpose of this post is to show how to build a web service in Python from scratch using a clean architecture. One of the main advantages of this layered design is testability, so I will develop it following a TDD approach. The project was initially developed from scratch in around 3 hours of work. Given the toy nature of the project some choices have been made to simplify the resulting code. Whenever meaningful I will point out those simplifications and discuss them.</p>
<p>If you want to know more about TDD in Python read the posts in <a href="/categories/tdd/">this category</a>.</p>
<h1 id="project-overview">Project overview<a class="headerlink" href="#project-overview" title="Permanent link">&para;</a></h1>
<p>The goal of the "Rent-o-matic" project (fans of Day of the Tentacle may get the reference) is to create a simple search engine on top of a dataset of objects which are described by some quantities. The search engine shall allow to set some filters to narrow the search.</p>
<p>The objects in the dataset are storage rooms for rent described by the following quantities:</p>
<ul>
<li>An unique identifier</li>
<li>A size in square meters</li>
<li>A renting price in Euro/day</li>
<li>Latitude and longitude</li>
</ul>
<p>As pushed by the clean architecture model, we are interested in separating the different layers of the system. The architecture is described by four layers, which however can be implemented by more than four actual code modules. I will give here a brief description of those layers.</p>
<h2 id="entities">Entities<a class="headerlink" href="#entities" title="Permanent link">&para;</a></h2>
<p>This is the level in which the domain models are described. Since we work in Python, I will put here the class that represent my storage rooms, with the data contained in the database, and whichever data I think is useful to perform the core business processing.</p>
<p>It is very important to understand that the models in this layer are different from the usual models of framework like Django. These models are not connected with a storage system, so they cannot be directly saved or queried using methods of their classes. They may however contain helper methods that implement code related to the business rules.</p>
<h2 id="use-cases">Use cases<a class="headerlink" href="#use-cases" title="Permanent link">&para;</a></h2>
<p>This layer contains the use cases implemented by the system. In this simple example there will be only one use case, which is the list of storage rooms according to the given filters. Here you would put for example a use case that shows the detail of a given storage room or every business process you want to implement, such as booking a storage room, filling it with goods, etc.</p>
<h2 id="interface-adapters">Interface Adapters<a class="headerlink" href="#interface-adapters" title="Permanent link">&para;</a></h2>
<p>This layer corresponds to the boundary between the business logic and external systems and implements the APIs used to exchange data with them. Both the storage system and the user interface are external systems that need to exchange data with the use cases and this layer shall provide an interface for this data flow. In this project the presentation part of this layer is provided by a JSON serializer, on top of which an external web service may be built. The storage adapter shall define here the common API of the storage systems. </p>
<h2 id="external-interfaces">External interfaces<a class="headerlink" href="#external-interfaces" title="Permanent link">&para;</a></h2>
<p>This part of the architecture is made by external systems that implement the interfaces defined in the previous layer. Here for example you will find a web server that implements (REST) entry points, which access the data provided by use cases through the JSON serializer. You will also find here the storage system implementation, for example a given database such as MongoDB.</p>
<h1 id="api-and-shades-of-grey">API and shades of grey<a class="headerlink" href="#api-and-shades-of-grey" title="Permanent link">&para;</a></h1>
<p>The word API is of uttermost importance in a clean architecture. Every layer may be accessed by an API, that is a fixed collection of entry points (methods or objects). Here "fixed" means "the same among every implementation", obviously an API may change with time. Every presentation tool, for example, will access the same use cases, and the same methods, to obtain a set of domain models, which are the output of that particular use case. It is up to the presentation layer to format data according to the specific presentation media, for example HTML, PDF, images, etc. If you understand plugin-based architectures you already grasped the main concept of a separate, API-driven component (or layer).</p>
<p>The same concept is valid for the storage layer. Every storage implementation shall provide the same methods. When dealing with use cases you shall not be concerned with the actual system that stores data, it may be a MongoDB local installation, a cloud storage system or a trivial in-memory dictionary.</p>
<p>The separation between layers, and the content of each layer, is not always fixed and immutable. A well-designed system shall also cope with practical world issues such as performances, for example, or other specific needs. When designing an architecture it is very important to know "what is where and why", and this is even more important when you "bend" the rules. Many issues do not have a black-or-white answer, and many decisions are "shades of grey", that is it is up to you to justify why you put something in a given place.</p>
<p>Keep in mind however, that you should not break the <em>structure</em> of the clean architecture, in particular you shall be inflexible about the data flow (see the "Crossing boundaries" section in the original post of Robert Martin). If you break the data flow, you are basically invalidating the whole structure. Let me stress it again: <strong>never break the data flow</strong>. A simple example of breaking the data flow is to let a use case output a Python class instead of a <em>representation</em> of that class such as a JSON string.</p>
<h1 id="project-structure">Project structure<a class="headerlink" href="#project-structure" title="Permanent link">&para;</a></h1>
<p>Let us take a look at the final structure of the project</p>
<p><structure here></p>
<p>The global structure of the package has been built with Cookiecutter, and I will run quickly through that part. The <code>rentomatic</code> directory contains the following subdirectories: <code>domain</code>, <code>repositories</code>, <code>REST</code>, <code>serializers</code>, <code>use_cases</code>. Those directories reflect the layered structure introduced in the previous section, and the structure of the <code>tests</code> directory mirrors this structure so that tests are easily found.</p>
<h1 id="source-code">Source code<a class="headerlink" href="#source-code" title="Permanent link">&para;</a></h1>
<p>You can find the source code in <a href="https://github.com/lgiordani/rentomatic">this GitHub repository</a>. Feel free to fork it and experiment, change it, and find better solutions to the problem I will discuss in this post. The source code contains tagged commits to allow you to follow the actual development as presented in the post. You can find the current tag in the <strong>Git tag: <code>&lt;tag name&gt;</code></strong> label under the section titles. The label is actually a link to the tagged commit on GitHub, if you want to see the code without cloning it.</p>
<h1 id="project-initialization">Project initialization<a class="headerlink" href="#project-initialization" title="Permanent link">&para;</a></h1>
<h4 id="git-tag-step01"><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step01">step01</a></strong><a class="headerlink" href="#git-tag-step01" title="Permanent link">&para;</a></h4>
<p><em>Update</em>: <a href="https://github.com/ardydedase/cookiecutter-pypackage">this</a> Cookiecutter package creates an environment like the one I am creating in this section. I will keep the following explanation so that you can see how to manage requirements and configurations, but for your next project consider using this automated tool.</p>
<p>I usually like maintaining a Python virtual environment inside the project, so I will create a temporary virtualenv to install cookiecutter, create the project, and remove the virtualenv. Cookiecutter is going to ask you some questions about you and the project, to provide an initial file structure. We are going to build our own testing environment, so it is safe to answer no to <code>use_pytest</code>. Since this is a demo project we are not going to need any publishing feature, so you can answer no to <code>use_pypi_deployment_with_travis</code> as well. The project does not have a command line interface, and you can safely create the author file and use any license.</p>
<div class="highlight"><pre><span></span><code>virtualenv venv3 -p python3
<span class="nb">source</span> venv3/bin/activate
pip install cookiecutter
cookiecutter https://github.com/audreyr/cookiecutter-pypackage
</code></pre></div>


<p>Now answer the questions, then finish creating the project with the following code</p>
<div class="highlight"><pre><span></span><code>deactivate
rm -fR venv3
<span class="nb">cd</span> rentomatic
virtualenv venv3 -p python3
<span class="nb">source</span> venv3/bin/activate
</code></pre></div>


<p>Get rid of the <code>requirements_dev.txt</code> file that Cookiecutter created for you. I usually store virtualenv requirements in different hierarchical files to separate production, development and testing environments, so create the <code>requirements</code> directory and the relative files</p>
<div class="highlight"><pre><span></span><code>mkdir requirements
touch requirements/prod.txt
touch requirements/dev.txt
touch requirements/test.txt
</code></pre></div>


<p>The <code>test.txt</code> file will contain specific packages used to test the project. Since to test the project you also need to install the packages for the production environment the file will first include the production one.</p>
<div class="highlight"><pre><span></span><code>-r prod.txt

pytest
tox
coverage
pytest-cov
</code></pre></div>


<p>The <code>dev.txt</code> file will contain packages used during the development process and shall install also test and production package</p>
<div class="highlight"><pre><span></span><code>-r test.txt

pip
wheel
flake8
Sphinx
</code></pre></div>


<p>(taking advantage of the fact that <code>test.txt</code> already includes <code>prod.txt</code>).</p>
<p>Last, the main <code>requirements.txt</code> file of the project will just import <code>requirements/prod.txt</code></p>
<div class="highlight"><pre><span></span><code>-r prod.txt
</code></pre></div>


<p>Obviously you are free to find the project structure that better suits your need or preferences. This is the structure we are going to use in this project but nothing forces you to follow it in your personal projects.</p>
<p>This separation allows you to install a full-fledged development environment on your machine, while installing only testing tools in a testing environment like the Travis platform and to further reduce the amount of dependencies in the production case. </p>
<p>As you can see, I am not using version tags in the requirements files. This is because this project is not going to be run in a production environment, so we do not need to freeze the environment.</p>
<p>Remember at this point to install the development requirements in your virtualenv</p>
<div class="highlight"><pre><span></span><code>$ pip install -r requirements/dev.txt
</code></pre></div>


<h2 id="miscellaneous-configuration">Miscellaneous configuration<a class="headerlink" href="#miscellaneous-configuration" title="Permanent link">&para;</a></h2>
<p>The <code>pytest</code> testing library needs to be configured. This is the <code>pytest.ini</code> file that you can create in the root directory (where the <code>setup.py</code> file is located)</p>
<div class="highlight"><pre><span></span><code>[pytest]
minversion = 2.0
norecursedirs = .git .tox venv* requirements*
python_files = test*.py
</code></pre></div>


<p>To run the tests during the development of the project just execute</p>
<div class="highlight"><pre><span></span><code>$ py.test -sv
</code></pre></div>


<p>If you want to check the coverage, i.e. the amount of code which is run by your tests or "covered", execute</p>
<div class="highlight"><pre><span></span><code>$ py.test --cov-report term-missing --cov<span class="o">=</span>rentomatic
</code></pre></div>


<p>If you want to know more about test coverage check the official documentation of the <a href="http://coverage.readthedocs.io/en/latest/">Coverage.py</a> and the <a href="http://pytest-cov.readthedocs.io/en/latest/index.html">pytest-cov</a> packages.</p>
<p>I strongly suggest the use of the <code>flake8</code> package to check that your Python code is PEP8 compliant. This is the <code>flake8</code> configuration that you can put in your <code>setup.cfg</code> file</p>
<div class="highlight"><pre><span></span><code>[flake8]
ignore = D203
exclude = .git, venv*, docs
max-complexity = 10
</code></pre></div>


<p>To check the compliance of your code with the PEP8 standard execute</p>
<div class="highlight"><pre><span></span><code>$ flake8
</code></pre></div>


<p>Flake8 documentation is available <a href="http://flake8.pycqa.org/en/latest/">here</a>.</p>
<p>Note that every step in this post produces tested code and a of coverage of 100%. One of the benefits of a clean architecture is the separation between layers, and this guarantees a great degree of testability. Note however that in this tutorial, in particular in the REST sections, some tests have been omitted in favour of a simpler description of the architecture. </p>
<h1 id="domain-models">Domain models<a class="headerlink" href="#domain-models" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step02">step02</a></strong></p>
<p>Let us start with a simple definition of the <code>StorageRoom</code> model. As said before, the clean architecture models are very lightweight, or at least they are lighter than their counterparts in a framework.</p>
<p>Following the TDD methodology the first thing that I write are the tests. Create the <code>tests/domain/test_storageroom.py</code> and put this code inside it</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">rentomatic.domain.storageroom</span> <span class="kn">import</span> <span class="n">StorageRoom</span>


<span class="k">def</span> <span class="nf">test_storageroom_model_init</span><span class="p">():</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
    <span class="n">storageroom</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">longitude</span><span class="o">=-</span><span class="mf">0.09998975</span><span class="p">,</span>
                              <span class="n">latitude</span><span class="o">=</span><span class="mf">51.75436293</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">longitude</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.09998975</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">latitude</span> <span class="o">==</span> <span class="mf">51.75436293</span>


<span class="k">def</span> <span class="nf">test_storageroom_model_from_dict</span><span class="p">():</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
    <span class="n">storageroom</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
            <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.75436293</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">longitude</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.09998975</span>
    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">latitude</span> <span class="o">==</span> <span class="mf">51.75436293</span>
</code></pre></div>


<p>With these two tests we ensure that our model can be initialized with the correct values and that can be created from a dictionary. In this first version all the parameters of the model are required. Later we could want to make some of them optional, and in that case we will have to add the relevant tests.</p>
<p>Now let's write the <code>StorageRoom</code> class in the <code>rentomatic/domain/storageroom.py</code> file. Do not forget to create the <code>__init__.py</code> file in the subdirectories of the project, otherwise Python will not be able to import the modules.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.shared.domain_model</span> <span class="kn">import</span> <span class="n">DomainModel</span>


<span class="k">class</span> <span class="nc">StorageRoom</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">latitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">longitude</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">adict</span><span class="p">):</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">adict</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="n">adict</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
            <span class="n">price</span><span class="o">=</span><span class="n">adict</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="n">latitude</span><span class="o">=</span><span class="n">adict</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
            <span class="n">longitude</span><span class="o">=</span><span class="n">adict</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">room</span>


<span class="n">DomainModel</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">StorageRoom</span><span class="p">)</span>
</code></pre></div>


<p>The model is very simple, and requires no further explanation. One of the benefits of a clean architecture is that each layer contains small pieces of code that, being isolated, shall perform simple tasks. In this case the model provides an initialization API and stores the information inside the class.</p>
<p>The <code>from_dict</code> method comes in handy when we have to create a model from data coming from another layer (such as the database layer or the query string of the REST layer).</p>
<p>One could be tempted to try to simplify the <code>from_dict</code> function, abstracting it and providing it through a <code>Model</code> class. Given that a certain level of abstraction and generalization is possible and desirable, the initialization part of the models shall probably deal with various different cases, and thus is better off being implemented directly in the class.</p>
<p>The <code>DomainModel</code> abstract base class is an easy way to categorize the model for future uses like checking if a class is a model in the system. For more information about this use of Abstract Base Classes in Python see <a href="https://www.thedigitalcatonline.com/blog/2016/04/03/abstract-base-classes-in-python/">this post</a>.</p>
<p>Since we have a method creates an object form a dictionary it is useful to have a method that returns a dictionary version of the object. This allows us to easily write a comparison operator between objects, that we will use later in some tests.</p>
<p>The new tests in <code>tests/domain/test_storageroom.py</code> are</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_storageroom_model_to_dict</span><span class="p">():</span>
    <span class="n">storageroom_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
        <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.75436293</span>
    <span class="p">}</span>

    <span class="n">storageroom</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">storageroom_dict</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">storageroom</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">storageroom_dict</span>


<span class="k">def</span> <span class="nf">test_storageroom_model_comparison</span><span class="p">():</span>
    <span class="n">storageroom_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
        <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.75436293</span>
    <span class="p">}</span>
    <span class="n">storageroom1</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">storageroom_dict</span><span class="p">)</span>
    <span class="n">storageroom2</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">storageroom_dict</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">storageroom1</span> <span class="o">==</span> <span class="n">storageroom2</span>
</code></pre></div>


<p>and the new methods of the object in <code>rentomatic/domain/storageroom.py</code> are</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
            <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div>


<h1 id="serializers">Serializers<a class="headerlink" href="#serializers" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step03">step03</a></strong></p>
<p>Our model needs to be serialized if we want to return it as a result of an API call. The typical serialization format is JSON, as this is a broadly accepted standard for web-based API. The serializer is not part of the model, but is an external specialized class that receives the model instance and produces a representation of its structure and values.</p>
<p>To test the JSON serialization of our <code>StorageRoom</code> class put in the <code>tests/serializers/test_storageroom_serializer.py</code> file the following code</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">rentomatic.serializers</span> <span class="kn">import</span> <span class="n">storageroom_serializer</span> <span class="k">as</span> <span class="n">srs</span>
<span class="kn">from</span> <span class="nn">rentomatic.domain.storageroom</span> <span class="kn">import</span> <span class="n">StorageRoom</span>


<span class="k">def</span> <span class="nf">test_serialize_domain_storageroom</span><span class="p">():</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>

    <span class="n">room</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=-</span><span class="mf">0.09998975</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.75436293</span>
    <span class="p">)</span>

    <span class="n">expected_json</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {{</span>
<span class="s2">            &quot;code&quot;: &quot;</span><span class="si">{}</span><span class="s2">&quot;,</span>
<span class="s2">            &quot;size&quot;: 200,</span>
<span class="s2">            &quot;price&quot;: 10,</span>
<span class="s2">            &quot;longitude&quot;: -0.09998975,</span>
<span class="s2">            &quot;latitude&quot;: 51.75436293</span>
<span class="s2">        }}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="n">json_storageroom</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">srs</span><span class="o">.</span><span class="n">StorageRoomEncoder</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_storageroom</span><span class="p">)</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">expected_json</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_serialize_domain_storageruum_wrong_type</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="n">srs</span><span class="o">.</span><span class="n">StorageRoomEncoder</span><span class="p">)</span>
</code></pre></div>


<p>Put in the <code>rentomatic/serializers/storageroom_serializer.py</code> file the code that makes the test pass</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>


<span class="k">class</span> <span class="nc">StorageRoomEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">to_serialize</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">code</span><span class="p">),</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">to_serialize</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</code></pre></div>


<p>Providing a class that inherits from <code>json.JSONEncoder</code> let us use the <code>json.dumps(room, cls=StorageRoomEncoder)</code> syntax to serialize the model.</p>
<p>There is a certain degree of repetition in the code we wrote, and this is the annoying part of a clean architecture. Since we want to isolate layers as much as possible and create lightweight classes we end up somehow repeating certain types of actions. For example the serialization code that assigns attributes of a <code>StorageRoom</code> to JSON attributes is very similar to that we use to create the object from a dictionary. Not exactly the same, obviously, but the two functions are very close.</p>
<h1 id="use-cases-part-1">Use cases (part 1)<a class="headerlink" href="#use-cases-part-1" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step04">step04</a></strong></p>
<p>It's time to implement the actual business logic our application wants to expose to the outside world. Use cases are the place where we implement classes that query the repository, apply business rules, logic, and whatever transformation we need for our data, and return the results.</p>
<p>With those requirements in mind, let us start to build a use case step by step. The simplest use case we can create is one that fetches all the storage rooms from the repository and returns them. Please note that we did not implement any repository layer yet, so our tests will mock it.</p>
<p>This is the skeleton for a basic test of a use case that lists all the storage rooms. Put this code in the <code>tests/use_cases/test_storageroom_list_use_case.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">from</span> <span class="nn">rentomatic.domain.storageroom</span> <span class="kn">import</span> <span class="n">StorageRoom</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">storageroom_use_cases</span> <span class="k">as</span> <span class="n">uc</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">domain_storagerooms</span><span class="p">():</span>
    <span class="n">storageroom_1</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">215</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">39</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=-</span><span class="mf">0.09998975</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.75436293</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">storageroom_2</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">66</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=</span><span class="mf">0.18228006</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.74640997</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">storageroom_3</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">56</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=</span><span class="mf">0.27891577</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.45994069</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">storageroom_4</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">93</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=</span><span class="mf">0.33894476</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.39916678</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">storageroom_1</span><span class="p">,</span> <span class="n">storageroom_2</span><span class="p">,</span> <span class="n">storageroom_3</span><span class="p">,</span> <span class="n">storageroom_4</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_storageroom_list_without_parameters</span><span class="p">(</span><span class="n">domain_storagerooms</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">domain_storagerooms</span>

    <span class="n">storageroom_list_use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">storageroom_list_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">domain_storagerooms</span>
</code></pre></div>


<p>The test is straightforward. First we mock the repository so that is provides a <code>list()</code> method that returns the list of models we created above the test. Then we initialize the use case with the repo and execute it, collecting the result. The first thing we check is if the repository method was called without any parameter, and the second is the effective correctness of the result.</p>
<p>This is the implementation of the use case that makes the test pass. Put the code in the <code>rentomatic/use_cases/storageroom_use_case.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StorageRoomListUseCase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</code></pre></div>


<p>With such an implementation of the use case, however, we will soon experience issues. For starters, we do not have a standard way to transport the call parameters, which means that we do not have a standard way to check for their correctness either. The second problem is that we miss a standard way to return the call results and consequently we lack a way to communicate if the call was successful of if it failed, and in the latter case what are the reasons of the failure. This applies also to the case of bad parameters discussed in the previous point.</p>
<p>We want thus to introduce some structures to wrap input and outputs of our use cases. Those structures are called request and response objects.</p>
<h1 id="requests-and-responses">Requests and responses<a class="headerlink" href="#requests-and-responses" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step05">step05</a></strong></p>
<p>Request and response objects are an important part of a clean architecture, as they transport call parameters, inputs and results from outside the application into the use cases layer.</p>
<p>More specifically, requests are objects created from incoming API calls, thus they shall deal with things like incorrect values, missing parameters, wrong formats, etc. Responses, on the other hand, have to contain the actual results of the API calls, but shall also be able to represent error cases and to deliver rich information on what happened.</p>
<p>The actual implementation of request and response objects is completely free, the clean architecture says nothing about them. The decision on how to pack and represent data is up to us.</p>
<p>For the moment we just need a <code>StorageRoomListRequestObject</code> that can be initialized without parameters, so let us create the file <code>tests/use_cases/test_storageroom_list_request_objects.py</code> and put there a test for this object.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">request_objects</span> <span class="k">as</span> <span class="n">ro</span>


<span class="k">def</span> <span class="nf">test_build_storageroom_list_request_object_without_parameters</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_build_file_list_request_object_from_empty_dict</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>


<p>While at the moment this request object is basically empty, it will come in handy as soon as we start having parameters for the list use case. The code of the <code>StorageRoomListRequestObject</code> is the following and goes into the <code>rentomatic/use_cases/request_objects.py</code> file</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StorageRoomListRequestObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">adict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StorageRoomListRequestObject</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>


<p>The response object is also very simple, since for the moment we just need a successful response. Unlike the request, the response is not linked to any particular use case, so the test file can be named <code>tests/shared/test_response_object.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">ro</span>


<span class="k">def</span> <span class="nf">test_response_success_is_true</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ro</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">())</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>


<p>and the actual response object is in the file <code>rentomatic/shared/response_object.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ResponseSuccess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>
</code></pre></div>


<h1 id="use-cases-part-2">Use cases (part 2)<a class="headerlink" href="#use-cases-part-2" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step06">step06</a></strong></p>
<p>Now that we have implemented the request and response object we can change the test code to include those structures. Change the <code>tests/use_cases/test_storageroom_list_use_case.py</code> to contain this code</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">from</span> <span class="nn">rentomatic.domain.storageroom</span> <span class="kn">import</span> <span class="n">StorageRoom</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">request_objects</span> <span class="k">as</span> <span class="n">ro</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">storageroom_use_cases</span> <span class="k">as</span> <span class="n">uc</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">domain_storagerooms</span><span class="p">():</span>
    <span class="n">storageroom_1</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">215</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">39</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=-</span><span class="mf">0.09998975</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.75436293</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">storageroom_2</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">66</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=</span><span class="mf">0.18228006</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.74640997</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">storageroom_3</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">56</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=</span><span class="mf">0.27891577</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.45994069</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">storageroom_4</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">93</span><span class="p">,</span>
        <span class="n">price</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
        <span class="n">longitude</span><span class="o">=</span><span class="mf">0.33894476</span><span class="p">,</span>
        <span class="n">latitude</span><span class="o">=</span><span class="mf">51.39916678</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">storageroom_1</span><span class="p">,</span> <span class="n">storageroom_2</span><span class="p">,</span> <span class="n">storageroom_3</span><span class="p">,</span> <span class="n">storageroom_4</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_storageroom_list_without_parameters</span><span class="p">(</span><span class="n">domain_storagerooms</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">domain_storagerooms</span>

    <span class="n">storageroom_list_use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="n">storageroom_list_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response_object</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">response_object</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">domain_storagerooms</span>
</code></pre></div>


<p>The new version of the <code>rentomatic/use_case/storageroom_use_cases.py</code> file is the following</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">ro</span>


<span class="k">class</span> <span class="nc">StorageRoomListUseCase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_object</span><span class="p">):</span>
        <span class="n">storage_rooms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ro</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">(</span><span class="n">storage_rooms</span><span class="p">)</span>
</code></pre></div>


<p>Let us consider what we have achieved with our clean architecture up to this point. We have a very lightweight model that can be serialized to JSON and which is completely independent from other parts of the system. The code also contains a use case that, given a repository that exposes a given API, extracts all the models and returns them contained in a structured object.</p>
<p>We are missing some objects, however. For example, we have not implemented any unsuccessful response object or validated the incoming request object.</p>
<p>To explore these missing parts of the architecture let us improve the current use case to accept a <code>filters</code> parameter that represents some filters that we want to apply to the extracted list of models. This will generate some possible error conditions for the input, forcing us to introduce some validation for the incoming request object.</p>
<h1 id="requests-and-validation">Requests and validation<a class="headerlink" href="#requests-and-validation" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step07">step07</a></strong></p>
<p>I want to add a <code>filters</code> parameter to the request. Through that parameter the caller can add different filters by specifying a name and a value for each filter (for instance <code>{'price_lt': 100}</code> to get all results with a price lesser than 100).</p>
<p>The first thing to do is to change the request object, starting from the test. The new version of the <code>tests/use_cases/test_storageroom_list_request_objects.py</code> file is the following</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">request_objects</span> <span class="k">as</span> <span class="n">ro</span>


<span class="k">def</span> <span class="nf">test_build_storageroom_list_request_object_without_parameters</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_build_file_list_request_object_from_empty_dict</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>

    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_build_storageroom_list_request_object_with_empty_filters</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{})</span>

    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">filters</span> <span class="o">==</span> <span class="p">{}</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_build_storageroom_list_request_object_from_dict_with_empty_filters</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{}})</span>

    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">filters</span> <span class="o">==</span> <span class="p">{}</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_build_storageroom_list_request_object_with_filters</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">filters</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_build_storageroom_list_request_object_from_dict_with_filters</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}})</span>

    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">filters</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_build_storageroom_list_request_object_from_dict_with_invalid_filters</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>

    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">has_errors</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;filters&#39;</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>


<p>As you can see I added the <code>assert req.filters is None</code> check to the original two tests, then I added 5 tests to check if filters can be specified and to test the behaviour of the object with an invalid filter parameter.</p>
<p>To make the tests pass we have to change our <code>StorageRoomListRequestObject</code> class. There are obviously multiple possible solutions that you can come up with, and I recommend you to try to find your own. This is the one I usually employ. The file <code>rentomatic/use_cases/request_object.py</code> becomes</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">collections</span>


<span class="k">class</span> <span class="nc">InvalidRequestObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">parameter</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">has_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>


<span class="k">class</span> <span class="nc">ValidRequestObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">adict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>


<span class="k">class</span> <span class="nc">StorageRoomListRequestObject</span><span class="p">(</span><span class="n">ValidRequestObject</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">adict</span><span class="p">):</span>
        <span class="n">invalid_req</span> <span class="o">=</span> <span class="n">InvalidRequestObject</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;filters&#39;</span> <span class="ow">in</span> <span class="n">adict</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adict</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">],</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="n">invalid_req</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">,</span> <span class="s1">&#39;Is not iterable&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">invalid_req</span><span class="o">.</span><span class="n">has_errors</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">invalid_req</span>

        <span class="k">return</span> <span class="n">StorageRoomListRequestObject</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">adict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</code></pre></div>


<p>Let me review this new code bit by bit.</p>
<p>First of all, two helper objects have been introduced, <code>ValidRequestObject</code> and <code>InvalidRequestObject</code>. They are different because an invalid request shall contain the validation errors, but both can be converted to booleans. </p>
<p>Second, the <code>StorageRoomListRequestObject</code> accepts an optional <code>filters</code> parameter when instantiated. There are no validation checks in the <code>__init__()</code> method because this is considered to be an internal method that gets called when the parameters have already been validated.</p>
<p>Last, the <code>from_dict()</code> method performs the validation of the <code>filters</code> parameter, if it is present. I leverage the <code>collections.Mapping</code> abstract base class to check if the incoming parameter is a dictionary-like object and return either an <code>InvalidRequestObject</code> or a <code>ValidRequestObject</code> instance.</p>
<p>Since we can now tell bad requests from good ones we need to introduce a new type of response as well, to manage bad requests or other errors in the use case.</p>
<h1 id="responses-and-failures">Responses and failures<a class="headerlink" href="#responses-and-failures" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step08">step08</a></strong></p>
<p>What happens if the use case encounter an error? Use cases can encounter a wide set of errors: validation errors, as we just discussed in the previous section, but also business logic errors or errors that come from the repository layer. Whatever the error, the use case shall always return an object with a known structure (the response), so we need a new object that provides a good support for different types of failures.</p>
<p>As happened for the requests there is no unique way to provide such an object, and the following code is just one of the possible solutions.</p>
<p>The first thing to do is to expand the <code>tests/shared/test_response_object.py</code> file, adding tests for failures.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">request_objects</span> <span class="k">as</span> <span class="n">req</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">response_value</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">]}</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">response_type</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;ResponseError&#39;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">response_message</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;This is a response error&#39;</span>
</code></pre></div>


<p>This is some boilerplate code, basically pytest fixtures that we will use in the following tests.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_response_success_is_true</span><span class="p">(</span><span class="n">response_value</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">(</span><span class="n">response_value</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_response_failure_is_false</span><span class="p">(</span><span class="n">response_type</span><span class="p">,</span> <span class="n">response_message</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="p">(</span><span class="n">response_type</span><span class="p">,</span> <span class="n">response_message</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>


<p>Two basic tests to check that both the old <code>ResponseSuccess</code> and the new <code>ResponseFailure</code> objects behave consistently when converted to boolean.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_response_success_contains_value</span><span class="p">(</span><span class="n">response_value</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">(</span><span class="n">response_value</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">response_value</span>
</code></pre></div>


<p>The <code>ResponseSuccess</code> object contains the call result in the <code>value</code> attribute.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_response_failure_has_type_and_message</span><span class="p">(</span><span class="n">response_type</span><span class="p">,</span> <span class="n">response_message</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="p">(</span><span class="n">response_type</span><span class="p">,</span> <span class="n">response_message</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">response_type</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">response_message</span>


<span class="k">def</span> <span class="nf">test_response_failure_contains_value</span><span class="p">(</span><span class="n">response_type</span><span class="p">,</span> <span class="n">response_message</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="p">(</span><span class="n">response_type</span><span class="p">,</span> <span class="n">response_message</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">response_type</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">response_message</span><span class="p">}</span>
</code></pre></div>


<p>These two tests ensure that the <code>ResponseFailure</code> object provides the same interface provided by the successful one and that the <code>type</code> and <code>message</code> parameter are accessible.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_response_failure_initialization_with_exception</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="p">(</span><span class="n">response_type</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Just an error message&#39;</span><span class="p">))</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">response_type</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;Exception: Just an error message&quot;</span>


<span class="k">def</span> <span class="nf">test_response_failure_from_invalid_request_object</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_from_invalid_request_object</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">InvalidRequestObject</span><span class="p">())</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">test_response_failure_from_invalid_request_object_with_errors</span><span class="p">():</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">InvalidRequestObject</span><span class="p">()</span>
    <span class="n">request_object</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;Is mandatory&#39;</span><span class="p">)</span>
    <span class="n">request_object</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s2">&quot;can&#39;t be blank&quot;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_from_invalid_request_object</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;path: Is mandatory</span><span class="se">\n</span><span class="s2">path: can&#39;t be blank&quot;</span>
</code></pre></div>


<p>We sometimes want to create responses from Python exceptions that can happen in the use case, so we test that <code>ResponseFailure</code> objects can be initialized with a generic exception.</p>
<p>And last we have the tests for the <code>build_from_invalid_request_object()</code> method that automate the initialization of the response from an invalid request. If the request contains errors (remember that the request validates itself), we need to put them into the response message.</p>
<p>The last test uses a class attribute to classify the error. The <code>ResponseFailure</code> class will contain three predefined errors that can happen when running the use case, namely <code>RESOURCE_ERROR</code>, <code>PARAMETERS_ERROR</code>, and <code>SYSTEM_ERROR</code>. This categorization is an attempt to capture the different types of issues that can happen when dealing with an external system through an API. <code>RESOURCE_ERROR</code> contains all those errors that are related to the resources contained in the repository, for instance when you cannot find an entry given its unique id. <code>PARAMETERS_ERROR</code> describes all those errors that occur when the request parameters are wrong or missing. <code>SYSTEM_ERROR</code> encompass the errors that happen in the underlying system at operating system level, such as a failure in a filesystem operation, or a network connection error while fetching data from the database.</p>
<p>The use case has the responsibility to manage the different error conditions arising from the Python code and to convert them into an error description made of one of the three types I just described and a message.</p>
<p>Let's write the <code>ResponseFailure</code> class that makes the tests pass. This can be the initial definition of the class. Put it in <code>rentomatic/shared/response_object.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ResponseFailure</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">RESOURCE_ERROR</span> <span class="o">=</span> <span class="s1">&#39;ResourceError&#39;</span>
    <span class="n">PARAMETERS_ERROR</span> <span class="o">=</span> <span class="s1">&#39;ParametersError&#39;</span>
    <span class="n">SYSTEM_ERROR</span> <span class="o">=</span> <span class="s1">&#39;SystemError&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">msg</span>
</code></pre></div>


<p>Through the <code>_format_message()</code> method we enable the class to accept both string messages and Python exceptions, which is very handy when dealing with external libraries that can raise exceptions we do not know or do not want to manage.</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
</code></pre></div>


<p>This property makes the class comply with the <code>ResponseSuccess</code> API, providing the <code>value</code> attribute, which is an aptly formatted dictionary.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_from_invalid_request_object</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">invalid_request_object</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">],</span> <span class="n">err</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">invalid_request_object</span><span class="o">.</span><span class="n">errors</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div>


<p>As explained before, the <code>PARAMETERS_ERROR</code> type encompasses all those errors that come from an invalid set of parameters, which is the case of this function, that shall be called whenever the request is wrong, which means that some parameters contain errors or are missing.</p>
<p>Since building failure responses is a common activity it is useful to have helper methods, so I add three tests for the building functions to the <code>tests/shared/test_response_object.py</code> file</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_response_failure_build_resource_error</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_resource_error</span><span class="p">(</span><span class="s2">&quot;test message&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">RESOURCE_ERROR</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;test message&quot;</span>


<span class="k">def</span> <span class="nf">test_response_failure_build_parameters_error</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_parameters_error</span><span class="p">(</span><span class="s2">&quot;test message&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;test message&quot;</span>


<span class="k">def</span> <span class="nf">test_response_failure_build_system_error</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_system_error</span><span class="p">(</span><span class="s2">&quot;test message&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;test message&quot;</span>
</code></pre></div>


<p>We add the relevant methods to the class and change the <code>build_from_invalid_request_object()</code> method to leverage the <code>build_parameters_error()</code> new method. Change the <code>rentomatic/shared/response_object.py</code> file to contain this code</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_resource_error</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">RESOURCE_ERROR</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_system_error</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_parameters_error</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_from_invalid_request_object</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">invalid_request_object</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">],</span> <span class="n">err</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">invalid_request_object</span><span class="o">.</span><span class="n">errors</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">build_parameters_error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>


<h1 id="use-cases-part-3">Use cases (part 3)<a class="headerlink" href="#use-cases-part-3" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step09">step09</a></strong></p>
<p>Our implementation of responses and requests is finally complete, so now we can implement the last version of our use case. The use case correctly returns a <code>ResponseSuccess</code> object but is still missing a proper validation of the incoming request.</p>
<p>Let's change the test in the <code>tests/use_cases/test_storageroom_list_use_case.py</code> file and add two more tests. The resulting set of tests (after the <code>domain_storagerooms</code> fixture) is the following</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">from</span> <span class="nn">rentomatic.domain.storageroom</span> <span class="kn">import</span> <span class="n">StorageRoom</span>
<span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">request_objects</span> <span class="k">as</span> <span class="n">req</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">storageroom_use_cases</span> <span class="k">as</span> <span class="n">uc</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">domain_storagerooms</span><span class="p">():</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_storageroom_list_without_parameters</span><span class="p">(</span><span class="n">domain_storagerooms</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">domain_storagerooms</span>

    <span class="n">storageroom_list_use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="n">storageroom_list_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response_object</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response_object</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">domain_storagerooms</span>
</code></pre></div>


<p>This is the test we already wrote, but the <code>assert_called_with()</code> method is called with <code>filters=None</code> to reflect the added parameter. The import line has slightly changed as well, given that we are now importing both <code>response_objects</code> and <code>request_objects</code>. The <code>domain_storagerooms</code> fixture has not changed and has been omitted from the code snippet to keep it short.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_storageroom_list_with_filters</span><span class="p">(</span><span class="n">domain_storagerooms</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">domain_storagerooms</span>

    <span class="n">storageroom_list_use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
    <span class="n">qry_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">qry_filters</span><span class="p">})</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="n">storageroom_list_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response_object</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">qry_filters</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response_object</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">domain_storagerooms</span>
</code></pre></div>


<p>This test checks that the value of the <code>filters</code> key in the dictionary used to create the request is actually used when calling the repository.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_storageroom_list_handles_generic_error</span><span class="p">():</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Just an error message&#39;</span><span class="p">)</span>

    <span class="n">storageroom_list_use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="n">storageroom_list_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response_object</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">response_object</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;Exception: Just an error message&quot;</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">test_storageroom_list_handles_bad_request</span><span class="p">():</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>

    <span class="n">storageroom_list_use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="n">storageroom_list_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response_object</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">response_object</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;filters: Is not iterable&quot;</span>
    <span class="p">}</span>
</code></pre></div>


<p>This last two tests check the behaviour of the use case when the repository raises an exception or when the request is badly formatted.</p>
<p>Change the file <code>rentomatic/use_cases/storageroom_use_cases.py</code> to contain the new use case implementation that makes all the test pass</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>


<span class="k">class</span> <span class="nc">StorageRoomListUseCase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_object</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request_object</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_from_invalid_request_object</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">storage_rooms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">request_object</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">(</span><span class="n">storage_rooms</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_system_error</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
</code></pre></div>


<p>As you can see the first thing that the <code>execute()</code> method does is to check if the request is valid, otherwise returns a <code>ResponseFailure</code> build with the same request object. Then the actual business logic is implemented, calling the repository and returning a success response. If something goes wrong in this phase the exception is caught and returned as an aptly formatted <code>ResponseFailure</code>.</p>
<h1 id="intermezzo-refactoring">Intermezzo: refactoring<a class="headerlink" href="#intermezzo-refactoring" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step10">step10</a></strong></p>
<p>A clean architecture is <em>not</em> a framework, so it provides very few generic features, unlike products like for example Django, which provide models, ORM, and all sorts of structures and libraries. Nevertheless, some classes can be isolated from our code and provided as a library, so that we can reuse the code. In this section I will guide you through a refactoring of the code we already have, during which we will isolate common features for requests, responses, and use cases.</p>
<p>We already isolated the response object. We can move the <code>test_valid_request_object_cannot_be_used</code> from <code>tests/use_cases/test_storageroom_list_request_objects.py</code> to <code>tests/shared/test_response_object.py</code> since it tests a generic behaviour and not something related to the <code>StorageRoom</code> model and use cases.</p>
<p>Then we can move the <code>InvalidRequestObject</code> and <code>ValidRequestObject</code> classes from <code>rentomatic/use_cases/request_objects.py</code> to <code>rentomatic/shared/request_object.py</code>, making the necessary changes to the <code>StorageRoomListRequestObject</code> class that now inherits from an external class.</p>
<p>The use case is the class that undergoes the major changes. The <code>UseCase</code> class is tested by the following code in the <code>tests/shared/test_use_case.py</code> file</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">request_object</span> <span class="k">as</span> <span class="n">req</span><span class="p">,</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>
<span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">use_case</span> <span class="k">as</span> <span class="n">uc</span>


<span class="k">def</span> <span class="nf">test_use_case_cannot_process_valid_requests</span><span class="p">():</span>
    <span class="n">valid_request_object</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">valid_request_object</span><span class="o">.</span><span class="fm">__bool__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">UseCase</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">valid_request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">response</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> \
        <span class="s1">&#39;NotImplementedError: process_request() not implemented by UseCase class&#39;</span>
</code></pre></div>


<p>This test checks that the <code>UseCase</code> class cannot be actually used to process incoming requests.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_use_case_can_process_invalid_requests_and_returns_response_failure</span><span class="p">():</span>
    <span class="n">invalid_request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">InvalidRequestObject</span><span class="p">()</span>
    <span class="n">invalid_request_object</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s1">&#39;someparam&#39;</span><span class="p">,</span> <span class="s1">&#39;somemessage&#39;</span><span class="p">)</span>

    <span class="n">use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">UseCase</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">invalid_request_object</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">response</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;someparam: somemessage&#39;</span>
</code></pre></div>


<p>This test runs the use case with an invalid request and check if the response is correct. Since the request is wrong the response type is <code>PARAMETERS_ERROR</code>, as this represents an issue in the request parameters.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_use_case_can_manage_generic_exception_from_process_request</span><span class="p">():</span>
    <span class="n">use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">UseCase</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">TestException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">use_case</span><span class="o">.</span><span class="n">process_request</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">use_case</span><span class="o">.</span><span class="n">process_request</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">TestException</span><span class="p">(</span><span class="s1">&#39;somemessage&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">response</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;TestException: somemessage&#39;</span>
</code></pre></div>


<p>This test makes the use case raise an exception. This type of error is categorized as <code>SYSTEM_ERROR</code>, which is a generic name for an exception which is not related to request parameters or actual entities.</p>
<p>As you can see in this last test the idea is that of exposing the <code>execute()</code> method in the <code>UseCase</code> class and to call the <code>process_request()</code> method defined by each child class, which is the actual use case we are implementing.</p>
<p>The <code>rentomatic/shared/use_case.py</code> file contains the following code that makes the test pass</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>


<span class="k">class</span> <span class="nc">UseCase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_object</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request_object</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_from_invalid_request_object</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_system_error</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_object</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;process_request() not implemented by UseCase class&quot;</span><span class="p">)</span>
</code></pre></div>


<p>While the <code>rentomatic/use_cases/storageroom_use_cases.py</code> now contains the following code</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">use_case</span> <span class="k">as</span> <span class="n">uc</span>
<span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>


<span class="k">class</span> <span class="nc">StorageRoomListUseCase</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UseCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_object</span><span class="p">):</span>
        <span class="n">domain_storageroom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">request_object</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">(</span><span class="n">domain_storageroom</span><span class="p">)</span>
</code></pre></div>


<h1 id="the-repository-layer">The repository layer<a class="headerlink" href="#the-repository-layer" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step11">step11</a></strong></p>
<p>The repository layer is the one in which we run the data storage system. As you saw when we implemented the use case we access the data storage through an API, in this case the <code>list()</code> method of the repository. The level of abstraction provided by a repository level is higher than that provided by an ORM or by a tool like SQLAlchemy. The repository layer provides only the endpoints that the application needs, with an interface which is tailored on the specific business problems the application implements.</p>
<p>To clarify the matter in terms of concrete technologies, SQLAlchemy is a wonderful tool to abstract the access to an SQL database, so the internal implementation of the repository layer could use it to access a PostgreSQL database. But the external API of the layer is not that provided by SQLAlchemy. The API is a (usually reduced) set of functions that the use cases call to get the data, and indeed the internal implementation could also use raw SQL queries on a proprietary network interface. The repository does not even need to be based on a database. We can have a repository layer that fetches data from a REST service, for example, or that makes remote procedure calls through a RabbitMQ network.</p>
<p>A very important feature of the repository layer is that it always returns domain models, and this is in line with what framework ORMs usually do.</p>
<p>I will not deploy a real database in this post. I will address that part of the application in a future post, where there will be enough space to implement two different solutions and show how the repository API can mask the actual implementation.</p>
<p>Instead, I am going to create a very simple memory storage system with some predefined data. I think this is enough for the moment to demonstrate the repository concept.</p>
<p>The first thing to do is to write some tests that document the public API of the repository. The file containing the tests is <code>tests/repository/test_memrepo.py</code>.</p>
<p>First we add some data that we will be using in the tests. We import the domain model to check if the results of the API calls have the correct type</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">rentomatic.domain.storageroom</span> <span class="kn">import</span> <span class="n">StorageRoom</span>
<span class="kn">from</span> <span class="nn">rentomatic.shared.domain_model</span> <span class="kn">import</span> <span class="n">DomainModel</span>

<span class="kn">from</span> <span class="nn">rentomatic.repository</span> <span class="kn">import</span> <span class="n">memrepo</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">storageroom_dicts</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;f853578c-fc0f-4e65-81b8-566c5dffa35a&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">215</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span>
            <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
            <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.75436293</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">405</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span>
            <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mf">0.18228006</span><span class="p">,</span>
            <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.74640997</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;913694c6-435a-4366-ba0d-da5334a611b2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mf">0.27891577</span><span class="p">,</span>
            <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.45994069</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;eed76e77-55c1-41ce-985d-ca49bf6c0585&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">93</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
            <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mf">0.33894476</span><span class="p">,</span>
            <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.39916678</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">]</span>
</code></pre></div>


<p>Since the repository object will return domain models, we need a helper function to check the correctness of the results. The following function checks the length of the two lists, ensures that all the returned elements are domain models and compares the codes. Note that we can safely employ the <code>isinstance()</code> built-in function since <code>DomainModel</code> is an abstract base class and our models are registered (see the <code>rentomatic/domain/storagerooms.py</code>)</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_check_results</span><span class="p">(</span><span class="n">domain_models_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">domain_models_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">DomainModel</span><span class="p">)</span> <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">domain_models_list</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">dm</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">domain_models_list</span><span class="p">]</span>
               <span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">])</span>
</code></pre></div>


<p>We need to be able to initialize the repository with a list of dictionaries, and the <code>list()</code> method without any parameter shall return the same list of entries.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_repository_list_without_parameters</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(),</span>
        <span class="n">storageroom_dicts</span>
    <span class="p">)</span>
</code></pre></div>


<p>The <code>list()</code> method shall accept a <code>filters</code> parameter, which is a dictionary. The dictionary keys shall be in the form <code>&lt;attribute&gt;__&lt;operator&gt;</code>, similar to the syntax used by the Django ORM. So to express that the price shall be less than 65 we can write <code>filters={'price__lt': 60}</code>.</p>
<p>A couple of error conditions shall be checked: using an unknown key shall raise a <code>KeyError</code> exception, and using a wrong operator shall raise a <code>ValueError</code> exception.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_repository_list_with_filters_unknown_key</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;aname&#39;</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_unknown_operator</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price__in&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]})</span>
</code></pre></div>


<p>Let us then test that the filtering mechanism actually works. We want the default operator to be <code>__eq</code>, which means that if we do not put any operator an equality check shall be performed.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_repository_list_with_filters_price</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_price_eq</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price__eq&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_price_lt</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price__lt&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_price_gt</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>
    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price__gt&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_size</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">93</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_size_eq</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>
    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size__eq&#39;</span><span class="p">:</span> <span class="mi">93</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_size_lt</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>
    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size__lt&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_size_gt</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>
    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size__gt&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_filters_code</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">memrepo</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">(</span><span class="n">storageroom_dicts</span><span class="p">)</span>

    <span class="n">_check_results</span><span class="p">(</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;913694c6-435a-4366-ba0d-da5334a611b2&#39;</span><span class="p">}),</span>
        <span class="p">[</span><span class="n">storageroom_dicts</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="p">)</span>
</code></pre></div>


<p>The implementation of the <code>MemRepo</code> class is pretty simple, and I will not dive into it line by line.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.domain</span> <span class="kn">import</span> <span class="n">storageroom</span> <span class="k">as</span> <span class="n">sr</span>


<span class="k">class</span> <span class="nc">MemRepo</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;__eq&#39;</span>

        <span class="n">key</span><span class="p">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="s1">&#39;gt&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Operator </span><span class="si">{}</span><span class="s1"> is not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operator</span><span class="p">))</span>

        <span class="n">operator</span> <span class="o">=</span> <span class="s1">&#39;__</span><span class="si">{}</span><span class="s1">__&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">operator</span><span class="p">)(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">operator</span><span class="p">)(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">operator</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">sr</span><span class="o">.</span><span class="n">StorageRoom</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
</code></pre></div>


<h1 id="the-rest-layer-part1">The REST layer (part1)<a class="headerlink" href="#the-rest-layer-part1" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step12">step12</a></strong></p>
<p>This is the last step of our journey into the clean architecture. We created the domain models, the serializers, the use cases and the repository. We are actually missing an interface that glues everything together, that is gets the call parameters from the user, initializes a use case with a repository, runs the use case that fetches the domain models from the repository and converts them to a standard format. This layer can be represented by a wide number of interfaces and technologies. For example a command line interface (CLI) can implement exactly those steps, getting the parameters via command line switches, and returning the results as plain text on the console. The same underlying system, however, can be leveraged by a web page that gets the call parameters from a set of widgets, perform the steps described above, and parses the returned JSON data to show the result on the same page.</p>
<p>Whatever technology we want to use to interact with the user to collect inputs and provide results we need to interface with the clean architecture we just built, so now we will create a layer to expose an HTTP API. This can be done with a server that exposes a set of HTTP addresses (API endpoints) that once accessed return some data. Such a layer is commonly called a REST layer, because usually the semantic of the addresses comes from the REST recommendations.</p>
<p>Flask is a lightweight web server with a modular structure that provides just the parts that the user needs. In particular, we will not use any database/ORM, since we already implemented our own repository layer.</p>
<p>Please keep in mind that this part of the project, together with the repository layer, is usually implemented as a separate package, and I am keeping them together just for the sake of this introductory tutorial.</p>
<p>Let us start updating the requirements files. The <code>dev.txt</code> file shall contain Flask</p>
<div class="highlight"><pre><span></span><code>-r test.txt

pip
wheel
flake8
Sphinx
Flask
</code></pre></div>


<p>And the <code>test.txt</code> file will contain the pytest extension to work with Flask (more on this later)</p>
<div class="highlight"><pre><span></span><code>-r prod.txt

pytest
tox
coverage
pytest-cov
pytest-flask
</code></pre></div>


<p>Remember to run <code>pip install -r requirements/dev.txt</code> again after those changes to actually install the new packages in your virtual environment.</p>
<p>The setup of a Flask application is not complex, but a lot of concepts are involved, and since this is not a tutorial on Flask I will run quickly through these steps. I will however provide links to the Flask documentation for every concept.</p>
<p>I usually define different configurations for my testing, development, and production environments. Since the Flask application can be configured using a plain Python object (<a href="https://flask.pocoo.org/docs/latest/api/#flask.Config.from_object">documentation</a>), I created the file <code>rentomatic/settings.py</code> to host those objects</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base configuration.&quot;&quot;&quot;</span>

    <span class="n">APP_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>  <span class="c1"># This directory</span>
    <span class="n">PROJECT_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">APP_DIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ProdConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Production configuration.&quot;&quot;&quot;</span>
    <span class="n">ENV</span> <span class="o">=</span> <span class="s1">&#39;prod&#39;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">DevConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Development configuration.&quot;&quot;&quot;</span>
    <span class="n">ENV</span> <span class="o">=</span> <span class="s1">&#39;dev&#39;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">TestConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test configuration.&quot;&quot;&quot;</span>
    <span class="n">ENV</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
    <span class="n">TESTING</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>


<p>Read <a href="https://flask.pocoo.org/docs/latest/config/">this page</a> to know more about Flask configuration parameters. Now we need a function that initializes the Flask application (<a href="https://flask.pocoo.org/docs/latest/patterns/appfactories/">documentation</a>), configures it and registers the blueprints (<a href="https://flask.pocoo.org/docs/latest/blueprints/">documentation</a>). The file <code>rentomatic/app.py</code> contains the following code</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="kn">from</span> <span class="nn">rentomatic.rest</span> <span class="kn">import</span> <span class="n">storageroom</span>
<span class="kn">from</span> <span class="nn">rentomatic.settings</span> <span class="kn">import</span> <span class="n">DevConfig</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_object</span><span class="o">=</span><span class="n">DevConfig</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config_object</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">storageroom</span><span class="o">.</span><span class="n">blueprint</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>


<p>The application endpoints need to return a Flask <code>Response</code> object, with the actual results and an HTTP status. The content of the response, in this case, is the JSON serialization of the use case response.</p>
<p>Let us write a test step by step, so that you can perfectly understand what is going to happen in the REST endpoint. The basic structure of the test is</p>
<div class="highlight"><pre><span></span><code>[SOME PREPARATION]
[CALL THE API ENDPOINT]
[CHECK RESPONSE DATA]
[CHECK RESPONSE STATUS CODE]
[CHECK RESPONSE MIMETYPE]
</code></pre></div>


<p>So our first test <code>tests/rest/test_get_storagerooms_list.py</code> is made of the following parts</p>
<div class="highlight"><pre><span></span><code><span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get</span><span class="p">(</span><span class="n">mock_use_case</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="n">mock_use_case</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">(</span><span class="n">storagerooms</span><span class="p">)</span>
</code></pre></div>


<p>Remember that we are not testing the use case here, so we can safely mock it. Here we make the use case return a <code>ResponseSuccess</code> instance containing a list of domain models (that we didn't define yet).</p>
<div class="highlight"><pre><span></span><code>    <span class="n">http_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/storagerooms&#39;</span><span class="p">)</span>
</code></pre></div>


<p>This is the actual API call. We are exposing the endpoint at the <code>/storagerooms</code> address. Note the use of the <code>client</code> fixture provided by <code>pytest-flask</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">assert</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">http_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="p">[</span><span class="n">storageroom1_dict</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">http_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">http_response</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">==</span> <span class="s1">&#39;application/json&#39;</span>
</code></pre></div>


<p>These are the three checks previously mentioned. The second and the third ones are pretty straightforward, while the first one needs some explanations. We want to compare <code>http_response.data</code> with <code>[storageroom1_dict]</code>, which is a list with a Python dictionary containing the data of the <code>storageroom1_domain_model</code> object. Flask <code>Response</code> objects contain a binary representation of the data, so first we decode the bytes using UTF-8, then convert them in a Python object. It is much more convenient to compare Python objects, since pytest can deal with issues like the unordered nature of dictionaries, while this is not possible when comparing two strings.  </p>
<p>The final test file, with the test domain model and its dictionary is</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">from</span> <span class="nn">rentomatic.domain.storageroom</span> <span class="kn">import</span> <span class="n">StorageRoom</span>
<span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>

<span class="n">storageroom1_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;3251a5bd-86be-428d-8ae9-6e51a8048c33&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.75436293</span>
<span class="p">}</span>

<span class="n">storageroom1_domain_model</span> <span class="o">=</span> <span class="n">StorageRoom</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">storageroom1_dict</span><span class="p">)</span>

<span class="n">storagerooms</span> <span class="o">=</span> <span class="p">[</span><span class="n">storageroom1_domain_model</span><span class="p">]</span>


<span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get</span><span class="p">(</span><span class="n">mock_use_case</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="n">mock_use_case</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">(</span><span class="n">storagerooms</span><span class="p">)</span>

    <span class="n">http_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/storagerooms&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">http_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="p">[</span><span class="n">storageroom1_dict</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">http_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">http_response</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">==</span> <span class="s1">&#39;application/json&#39;</span>
</code></pre></div>


<p>If you run pytest you'll notice that the test suite fails because of the <code>app</code> fixture, which is missing. The <code>pytest-flask</code> plugin provides the <code>client</code> fixture, but relies on the <code>app</code> fixture which has to be provided. The best place to define it is in <code>tests/conftest.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>


<span class="kn">from</span> <span class="nn">rentomatic.app</span> <span class="kn">import</span> <span class="n">create_app</span>
<span class="kn">from</span> <span class="nn">rentomatic.settings</span> <span class="kn">import</span> <span class="n">TestConfig</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">yield_fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_app</span><span class="p">(</span><span class="n">TestConfig</span><span class="p">)</span>
</code></pre></div>


<p>It's time to write the endpoint, where we will finally see all the pieces of the architecture working together. </p>
<p>The minimal Flask endpoint we can put in <code>rentomatic/rest/storageroom.py</code> is something like</p>
<div class="highlight"><pre><span></span><code><span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;storageroom&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/storagerooms&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">storageroom</span><span class="p">():</span>
    <span class="p">[</span><span class="n">LOGIC</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">([</span><span class="n">JSON</span> <span class="n">DATA</span><span class="p">],</span>
                    <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="p">[</span><span class="n">STATUS</span><span class="p">])</span>
</code></pre></div>


<p>The first part of our logic is the creation of a <code>StorageRoomListRequestObject</code>. For the moment we can ignore the optional querystring parameters and use an empty dictionary</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">storageroom</span><span class="p">():</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>
</code></pre></div>


<p>As you can see I'm creating the object from an empty dictionary, so querystring parameters are not taken into account for the moment. The second thing to do is to initialize the repository</p>
<div class="highlight"><pre><span></span><code>    <span class="n">repo</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">()</span>
</code></pre></div>


<p>The third thing the endpoint has to do is the initialization of the use case</p>
<div class="highlight"><pre><span></span><code>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</code></pre></div>


<p>And finally we run the use case passing the request object</p>
<div class="highlight"><pre><span></span><code>    <span class="n">response</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>
</code></pre></div>


<p>This response, however, is not yet an HTTP response, and we have to explicitly build it. The HTTP response will contain the JSON representation of the <code>response.value</code> attribute.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">ser</span><span class="o">.</span><span class="n">StorageRoomEncoder</span><span class="p">),</span>
                    <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div>


<p>Note that this function is obviously still incomplete, as it returns always a successful response (code 200). It is however enough to pass the test we wrote. The whole file is the following</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">Response</span>

<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">request_objects</span> <span class="k">as</span> <span class="n">req</span>
<span class="kn">from</span> <span class="nn">rentomatic.repository</span> <span class="kn">import</span> <span class="n">memrepo</span> <span class="k">as</span> <span class="n">mr</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">storageroom_use_cases</span> <span class="k">as</span> <span class="n">uc</span>
<span class="kn">from</span> <span class="nn">rentomatic.serializers</span> <span class="kn">import</span> <span class="n">storageroom_serializer</span> <span class="k">as</span> <span class="n">ser</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;storageroom&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/storagerooms&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">storageroom</span><span class="p">():</span>
    <span class="n">request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>

    <span class="n">repo</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">()</span>
    <span class="n">use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">ser</span><span class="o">.</span><span class="n">StorageRoomEncoder</span><span class="p">),</span>
                    <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div>


<p>This code demonstrates how the clean architecture works in a nutshell. The function we wrote is however not complete, as it doesn't consider querystring parameters and error cases.</p>
<h1 id="the-server-in-action">The server in action<a class="headerlink" href="#the-server-in-action" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step13">step13</a></strong></p>
<p>Before I fix the missing parts of the endpoint let us see the server in action, so we can finally enjoy the product we have been building during this long post.</p>
<p>To actually see some results when accessing the endpoint we need to fill the repository with some data. This part is obviously required only because of the ephemeral nature of the repository we are using. A real repository would wrap a persistent source of data and providing data at this point wouldn't be necessary. To initialize the repository we have to define some data, so add these dictionaries to the <code>rentomatic/rest/storageroom.py</code> file</p>
<div class="highlight"><pre><span></span><code><span class="n">storageroom1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;f853578c-fc0f-4e65-81b8-566c5dffa35a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">215</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.75436293</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">storageroom2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">405</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mf">0.18228006</span><span class="p">,</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.74640997</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">storageroom3</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;913694c6-435a-4366-ba0d-da5334a611b2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mf">0.27891577</span><span class="p">,</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">51.45994069</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>


<p>And then use them to initialise the repository</p>
<div class="highlight"><pre><span></span><code>    <span class="n">repo</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">([</span><span class="n">storageroom1</span><span class="p">,</span> <span class="n">storageroom2</span><span class="p">,</span> <span class="n">storageroom3</span><span class="p">])</span>
</code></pre></div>


<p>To run the web server we need to create a <code>wsgi.py</code> file in the main project folder (the folder where <code>setup.py</code> is stored)</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.app</span> <span class="kn">import</span> <span class="n">create_app</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
</code></pre></div>


<p>Now we can run the Flask development server</p>
<div class="highlight"><pre><span></span><code>$ flask run
</code></pre></div>


<p>At this point, if you open your browser and navigate to <a href="http://localhost:5000/storagerooms">http://localhost:5000/storagerooms</a>, you can see the API call results. I recommend installing a formatter extension for the browser to better check the output. If you are using Chrome try <a href="https://github.com/callumlocke/json-formatter">JSON Formatter</a>.</p>
<h1 id="the-rest-layer-part2">The REST layer (part2)<a class="headerlink" href="#the-rest-layer-part2" title="Permanent link">&para;</a></h1>
<p><strong>Git tag: <a href="https://github.com/lgiordani/rentomatic/tree/step14">step14</a></strong></p>
<p>Let us cover the two missing cases in the endpoint. First I introduce a test to check if the endpoint correctly handles querystring parameters. Add it to the <code>tests/rest/test_get_storagerooms_list.py</code> file</p>
<div class="highlight"><pre><span></span><code><span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
    <span class="s1">&#39;rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_failed_response</span><span class="p">(</span><span class="n">mock_use_case</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="n">mock_use_case</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> \
        <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">build_system_error</span><span class="p">(</span><span class="s1">&#39;test message&#39;</span><span class="p">)</span>

    <span class="n">http_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/storagerooms&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">http_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span> <span class="o">==</span> \
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SYSTEM_ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;test message&#39;</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">http_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span>
    <span class="k">assert</span> <span class="n">http_response</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">==</span> <span class="s1">&#39;application/json&#39;</span>
</code></pre></div>


<p>This makes the use case return a failed response and check that the HTTP response contains a formatted version of the error. To make this test pass we have to introduce a proper mapping between domain responses codes and HTTP codes in the <code>rentomatic/rest/storageroom.py</code> file</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>

<span class="n">STATUS_CODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">RESOURCE_ERROR</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span><span class="p">:</span> <span class="mi">500</span>
<span class="p">}</span>
</code></pre></div>


<p>Then we need to create the Flask response with the correct code in the definition of the endpoint</p>
<div class="highlight"><pre><span></span><code>    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">ser</span><span class="o">.</span><span class="n">StorageRoomEncoder</span><span class="p">),</span>
                    <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">STATUS_CODES</span><span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">type</span><span class="p">])</span>
</code></pre></div>


<p>The second and last test is a bit more complex. As before we will mock the use case, but this time we will also patch <code>StorageRoomListRequestObject</code>. We do this because we need to know if the request object is initialized with the correct parameters from the command line. So, step by step</p>
<div class="highlight"><pre><span></span><code><span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;rentomatic.use_cases.storageroom_use_cases.StorageRoomListUseCase&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_request_object_initialisation_and_use_with_filters</span><span class="p">(</span><span class="n">mock_use_case</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="n">mock_use_case</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="p">([])</span>
</code></pre></div>


<p>This is, like, before, a patch of the use case class that ensures the use case will return a <code>ResponseSuccess</code> instance.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">internal_request_object</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
</code></pre></div>


<p>The request object will be internally created with <code>StorageRoomListRequestObject.from_dict</code>, and we want that function to return a known mock object, which is the one we initialized here.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">request_object_class</span> <span class="o">=</span> <span class="s1">&#39;rentomatic.use_cases.request_objects.StorageRoomListRequestObject&#39;</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">request_object_class</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_request_object</span><span class="p">:</span>
        <span class="n">mock_request_object</span><span class="o">.</span><span class="n">from_dict</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">internal_request_object</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/storagerooms?filter_param1=value1&amp;filter_param2=value2&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Here we patch <code>StorageRoomListRequestObject</code> and we assign a known output to the <code>from_dict()</code> method. Then we call the endpoint with some querystring parameters. What should happen is that the <code>from_dict()</code> method of the request is called with the filter parameters and that the <code>execute()</code> method of the use case instance is called with the <code>internal_request_object</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">mock_request_object</span><span class="o">.</span><span class="n">from_dict</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;param1&#39;</span><span class="p">:</span> <span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;param2&#39;</span><span class="p">:</span> <span class="s1">&#39;value2&#39;</span><span class="p">}}</span>
    <span class="p">)</span>
    <span class="n">mock_use_case</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">internal_request_object</span><span class="p">)</span>
</code></pre></div>


<p>The endpoint function shall be changed somehow to reflect this new behaviour and to make the test pass. The whole code of the new <code>storageroom()</code> Flask method is the following</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span>

<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">request_objects</span> <span class="k">as</span> <span class="n">req</span>
<span class="kn">from</span> <span class="nn">rentomatic.shared</span> <span class="kn">import</span> <span class="n">response_object</span> <span class="k">as</span> <span class="n">res</span>
<span class="kn">from</span> <span class="nn">rentomatic.repository</span> <span class="kn">import</span> <span class="n">memrepo</span> <span class="k">as</span> <span class="n">mr</span>
<span class="kn">from</span> <span class="nn">rentomatic.use_cases</span> <span class="kn">import</span> <span class="n">storageroom_use_cases</span> <span class="k">as</span> <span class="n">uc</span>
<span class="kn">from</span> <span class="nn">rentomatic.serializers</span> <span class="kn">import</span> <span class="n">storageroom_serializer</span> <span class="k">as</span> <span class="n">ser</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;storageroom&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>

<span class="n">STATUS_CODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseSuccess</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">RESOURCE_ERROR</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">PARAMETERS_ERROR</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ResponseFailure</span><span class="o">.</span><span class="n">SYSTEM_ERROR</span><span class="p">:</span> <span class="mi">500</span>
<span class="p">}</span>

<span class="n">storageroom1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;f853578c-fc0f-4e65-81b8-566c5dffa35a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">215</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;-0.09998975&#39;</span><span class="p">,</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;51.75436293&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">storageroom2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">405</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;0.18228006&#39;</span><span class="p">,</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;51.74640997&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">storageroom3</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;913694c6-435a-4366-ba0d-da5334a611b2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;0.27891577&#39;</span><span class="p">,</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;51.45994069&#39;</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/storagerooms&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">storageroom</span><span class="p">():</span>
    <span class="n">qrystr_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;filter_&#39;</span><span class="p">):</span>
            <span class="n">qrystr_params</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">][</span><span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;filter_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span>

    <span class="n">request_object</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">StorageRoomListRequestObject</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">qrystr_params</span><span class="p">)</span>

    <span class="n">repo</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">MemRepo</span><span class="p">([</span><span class="n">storageroom1</span><span class="p">,</span> <span class="n">storageroom2</span><span class="p">,</span> <span class="n">storageroom3</span><span class="p">])</span>
    <span class="n">use_case</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">StorageRoomListUseCase</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request_object</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">ser</span><span class="o">.</span><span class="n">StorageRoomEncoder</span><span class="p">),</span>
                    <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">STATUS_CODES</span><span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">type</span><span class="p">])</span>
</code></pre></div>


<p>Note that we extract the querystring parameters from the global <code>request</code> object provided by Flask. Once the querystring parameters are in a dictionary, we just need to create the request object from it.</p>
<h2 id="conclusions">Conclusions<a class="headerlink" href="#conclusions" title="Permanent link">&para;</a></h2>
<p>Well, that's all! Some tests are missing in the REST part, but as I said I just wanted to show a working implementation of a clean architecture and not a fully developed project. I suggest that you try to implement some changes, for example:</p>
<ul>
<li>another endpoint like the access to a single resource (<code>/storagerooms/&lt;code&gt;</code>)</li>
<li>a different repository, connected to a real DB (you can use <a href="https://sqlite.org/">SQLite</a>, for example)</li>
<li>implement a new querystring parameter, for example the distance from a given point on the map (use <a href="https://github.com/geopy/geopy">geopy</a> to easily compute distances)</li>
</ul>
<p>While you develop your code always try to work following the TDD approach. Testability is one of the main features of a clean architecture, so don't ignore it.</p>
<p>Whether you decide to use a clean architecture or not, I really hope this post helped you to get a fresh view on software architectures, as happened to me when I first discovered the concepts exemplified here.</p>
<h2 id="updates">Updates<a class="headerlink" href="#updates" title="Permanent link">&para;</a></h2>
<p>2016-11-15: Two tests contained variables with a wrong name (artist), which came from an initial version of the project. The name did not affect the tests. Added some instructions on the virtual environment and the development requirements.</p>
<p>2016-12-12: Thanks to <a href="https://twitter.com/Taifu">Marco Beri</a> who spotted a typo in the code of step 6, which was already correct in the GitHub repository. He also suggested using the Cookiecutter package by <a href="https://github.com/ardydedase">Ardy Dedase</a>. Thanks to Marco and to Ardy!</p>
<p>2018-11-18 Two years have passed since I wrote this post and I found some errors that I fixed, like <code>longitude</code> and <code>latitude</code> passed as string instead of floats. I also moved the project from Flask-script to the Flask development server and added a couple of clarifications here and there.</p>
<p>2018-11-28 Fixed a typo. Thanks <a href="https://github.com/slackorama">Seth Mason</a>!</p>
<h2 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h2>
<p>The <a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
  </section>


  <section class="footer">
    <h1>Related Posts</h1>
    <div class="posts mini">
      <article class="card">
        <a href="/blog/2018/12/20/cabook/" class="image">
          <img src="/images/cabook.jpg" alt="cabook" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/12/20/cabook/"><h2 class="card-title">Clean Architectures in Python: the book</h2></a>
	  <p class="article-info">
            <time datetime="2018-12-20T08:00:00+01:00">Dec 20, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/architectures/" class="tag">architectures</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2016/09/27/python-mocks-a-gentle-introduction-part-2/" class="image">
          <img src="/images/python-mocks.jpg" alt="python-mocks" />
        </a>
        <div class="card-body">
          <a href="/blog/2016/09/27/python-mocks-a-gentle-introduction-part-2/"><h2 class="card-title">Python Mocks: a gentle introduction - Part 2</h2></a>
	  <p class="article-info">
            <time datetime="2016-09-27T09:00:00+00:00">Sep 27, 2016</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/decorators/" class="tag">decorators</a>            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2016/03/06/python-mocks-a-gentle-introduction-part-1/" class="image">
          <img src="/images/python-mocks.jpg" alt="python-mocks" />
        </a>
        <div class="card-body">
          <a href="/blog/2016/03/06/python-mocks-a-gentle-introduction-part-1/"><h2 class="card-title">Python Mocks: a gentle introduction - Part 1</h2></a>
	  <p class="article-info">
            <time datetime="2016-03-06T18:00:00+01:00">Mar 6, 2016</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/decorators/" class="tag">decorators</a>            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/" class="image">
          <img src="/images/refactoring-with-tests-in-python.jpg" alt="refactoring-with-tests-in-python" />
        </a>
        <div class="card-body">
          <a href="/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/"><h2 class="card-title">Refactoring with tests in Python: a practical example</h2></a>
	  <p class="article-info">
            <time datetime="2017-07-21T09:30:00+01:00">Jul 21, 2017</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/refactoring/" class="tag">refactoring</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2016/04/03/abstract-base-classes-in-python/" class="image">
          <img src="/images/abstract-base-classes.jpg" alt="abstract-base-classes" />
        </a>
        <div class="card-body">
          <a href="/blog/2016/04/03/abstract-base-classes-in-python/"><h2 class="card-title">Abstract Base Classes in Python</h2></a>
	  <p class="article-info">
            <time datetime="2016-04-03T11:00:00+01:00">Apr 3, 2016</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/decorators/" class="tag">decorators</a>            <a href="/categories/metaclasses/" class="tag">metaclasses</a>            <a href="/categories/metaprogramming/" class="tag">metaprogramming</a>            <a href="/categories/notebook/" class="tag">Notebook</a>            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2015/09/10/python-oop-tdd-example-part2/" class="image">
          <img src="/images/python-oop-tdd.jpg" alt="python-oop-tdd" />
        </a>
        <div class="card-body">
          <a href="/blog/2015/09/10/python-oop-tdd-example-part2/"><h2 class="card-title">A simple example of Python OOP development (with TDD) - Part 2</h2></a>
	  <p class="article-info">
            <time datetime="2015-09-10T20:00:00+01:00">Sep 10, 2015</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2015/05/13/python-oop-tdd-example-part1/" class="image">
          <img src="/images/python-oop-tdd.jpg" alt="python-oop-tdd" />
        </a>
        <div class="card-body">
          <a href="/blog/2015/05/13/python-oop-tdd-example-part1/"><h2 class="card-title">A simple example of Python OOP development (with TDD) - Part 1</h2></a>
	  <p class="article-info">
            <time datetime="2015-05-13T17:00:00+01:00">May 13, 2015</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2019/05/27/youtube-channel/" class="image">
          <img src="/images/youtube-channel.jpg" alt="youtube-channel" />
        </a>
        <div class="card-body">
          <a href="/blog/2019/05/27/youtube-channel/"><h2 class="card-title">The Digital Cat Youtube Channel</h2></a>
	  <p class="article-info">
            <time datetime="2019-05-27T12:00:00+01:00">May 27, 2019</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/video/" class="tag">video</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/07/05/useful-pytest-command-line-options/" class="image">
          <img src="/images/useful-pytest-command-line-options.jpg" alt="useful-pytest-command-line-options" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/07/05/useful-pytest-command-line-options/"><h2 class="card-title">Useful pytest command line options</h2></a>
	  <p class="article-info">
            <time datetime="2018-07-05T11:00:00+01:00">Jul 5, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2020/04/26/object-oriented-programming-concepts-in-python/" class="image">
          <img src="/images/object-oriented-programming-concepts-in-python.jpg" alt="object-oriented-programming-concepts-in-python" />
        </a>
        <div class="card-body">
          <a href="/blog/2020/04/26/object-oriented-programming-concepts-in-python/"><h2 class="card-title">Object-Oriented Programming (OOP) concepts in Python</h2></a>
	  <p class="article-info">
            <time datetime="2020-04-26T00:00:00+01:00">Apr 26, 2020</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/metaclasses/" class="tag">metaclasses</a>            <a href="/categories/metaprogramming/" class="tag">metaprogramming</a>            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>          </p>
        </div>
      </article>
    </div>
  </section>



  <!-- </article> -->

						</div>
					</div>

				<!-- Sidebar -->
					<div id="sidebar">
<div class="inner">
    <!-- Menu -->
        <nav id="menu">
            <header class="major">
                <h2>Menu</h2>
            </header>
<ul>
    <li><a href="/index.html">Homepage</a></li>
    <li><a href="/pages/about.html">About</a></li>
    <li><a href="/archives/index.html">Archives</a></li>
</ul>        </nav>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Categories</h2>
            </header>
<ul class="list-clean">
    <li><a href="/category/programming/">Programming</a></li>
    <li><a href="/category/projects/">Projects</a></li>
    <li><a href="/category/retro/">Retro</a></li>
</ul>
        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Feeds</h2>
            </header>
<ul class="list-clean">
    <li><a href="/atom.xml"><i class="fas fa-rss"></i> All posts</a></li>


    <li><a href="/category/programming/atom.xml"><i class="fas fa-rss"></i> All posts in category: Programming</a></li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Tags</h2>
            </header>
<ul class="list-inline list-clean" id="tags-side">
    <li class="tag font-size-3">
        <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Recent posts</h2>
            </header>
<div class="mini-posts">
    <article>
        <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/" class="image"><img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-3.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-3" /></a>
        <p><strong>Flask project setup: TDD, Docker, Postgres and more - Part 3</strong> <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/" class="image"><img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-2.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-2" /></a>
        <p><strong>Flask project setup: TDD, Docker, Postgres and more - Part 2</strong> <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/" class="image"><img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-1.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-1" /></a>
        <p><strong>Flask project setup: TDD, Docker, Postgres and more - Part 1</strong> <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/">Read</a></p> 
    </article>
</div>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Get in touch</h2>
            </header>
<ul class="contact">
    
    
    
    <li class="fa-twitter"><a href="https://twitter.com/thedigicat">Twitter</a></li>
    
    
    
    
    <li class="fa-github"><a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
    
</ul>        </section>

    <!-- Footer -->
        <footer id="footer">
            <p class="copyright">Editorial theme by: <a href="https://html5up.net">HTML5 UP</a>.</p>
            <p class="copyright">Cover picture by: <a href="https://pxhere.com/en/photo/1428515">An Min @ pxhere.com</a></p>
        </footer>

</div>					</div>

			</div>

		<!-- Scripts -->
			<script src="/theme/js/jquery.min.js"></script>
			<script src="/theme/js/browser.min.js"></script>
			<script src="/theme/js/breakpoints.min.js"></script>
            <script src="/theme/js/packed.js?fa89ff81"></script>

	</body>
</html>